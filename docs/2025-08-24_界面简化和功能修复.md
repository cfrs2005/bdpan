# 2025-08-24 ç•Œé¢ç®€åŒ–å’ŒåŠŸèƒ½ä¿®å¤

## ä¸»è¦æ”¹è¿›

### 1. ç•Œé¢ç®€åŒ–
**é—®é¢˜**: ç”¨æˆ·éœ€è¦åˆ†åˆ«è¾“å…¥ BDUSS å’Œå®Œæ•´ Cookie å­—ç¬¦ä¸²ï¼Œæ“ä½œå¤æ‚
**è§£å†³æ–¹æ¡ˆ**: 
- åˆå¹¶ä¸¤ä¸ªè¾“å…¥æ¡†ä¸ºä¸€ä¸ª"ç™¾åº¦ç½‘ç›˜Cookie"è¾“å…¥æ¡†
- åç«¯æ™ºèƒ½è§£æå®Œæ•´Cookieå­—ç¬¦ä¸²ï¼Œè‡ªåŠ¨æå–BDUSSå€¼
- ç®€åŒ–ç”¨æˆ·æ“ä½œæµç¨‹

**ä¿®æ”¹æ–‡ä»¶**:
- `templates/config.html`: ç®€åŒ–Cookieè¾“å…¥ç•Œé¢
- `static/js/baidu-auth.js`: æ›´æ–°å‰ç«¯é€»è¾‘é€‚é…ç®€åŒ–ç•Œé¢

### 2. æœç´¢åŠŸèƒ½è´¦æˆ·æ£€æŸ¥ä¿®å¤
**é—®é¢˜**: æœç´¢æ—¶æŠ¥é”™"è¯·å…ˆåœ¨é…ç½®é¡µé¢æ·»åŠ æ‚¨çš„Baiduç½‘ç›˜è´¦æˆ·"ï¼Œä½†å®é™…å·²æ·»åŠ 
**åŸå› **: `check_auth_ready()` å‡½æ•°ä½¿ç”¨æ—§çš„ç›´æ¥å¯¼å…¥æ–¹å¼ï¼Œæ²¡æœ‰ä½¿ç”¨ä¿®å¤åçš„è®¤è¯ç®¡ç†å™¨
**è§£å†³æ–¹æ¡ˆ**:
```python
def check_auth_ready():
    try:
        auth_mgr = get_auth_manager()  # ä½¿ç”¨ç»Ÿä¸€çš„è®¤è¯ç®¡ç†å™¨
        if not auth_mgr:
            return False, "BaiduPCS-Pyåº“ä¸å¯ç”¨"
        
        _, api = auth_mgr.get_current_account()
        if api:
            success, message = auth_mgr.test_account()
            return success, message
        else:
            return False, "è¯·å…ˆåœ¨é…ç½®é¡µé¢æ·»åŠ æ‚¨çš„Baiduç½‘ç›˜è´¦æˆ·"
    except Exception as e:
        return False, f"è®¤è¯æ£€æŸ¥å¤±è´¥: {str(e)}"
```

### 3. ç³»ç»ŸçŠ¶æ€é¡µé¢ä¿®å¤
**é—®é¢˜**: ç³»ç»ŸçŠ¶æ€é¡µé¢æ˜¾ç¤º"BaiduPCS-Py ç‰ˆæœ¬: éœ€æ‰‹åŠ¨å®‰è£…, ç™»å½•çŠ¶æ€: æœªçŸ¥"
**åŸå› **: ç¼ºå°‘ `/api/pan-status` API ç«¯ç‚¹
**è§£å†³æ–¹æ¡ˆ**: æ·»åŠ æ–°çš„APIç«¯ç‚¹
```python
@app.route('/api/pan-status')
def api_pan_status():
    try:
        auth_mgr = get_auth_manager()
        if not auth_mgr:
            return jsonify({
                "status": "error",
                "version": "åº“æœªå®‰è£…",
                "logged_in": False
            })
        
        current_account, api = auth_mgr.get_current_account()
        logged_in = api is not None
        
        if logged_in:
            success, message = auth_mgr.test_account()
            logged_in = success
        
        return jsonify({
            "status": "ok",
            "version": "0.7.6",
            "logged_in": logged_in,
            "current_account": current_account,
            "message": "BaiduPCS-Pyåº“å¯ç”¨"
        })
    except Exception as e:
        return jsonify({
            "status": "error",
            "message": f"çŠ¶æ€æ£€æŸ¥å¤±è´¥: {str(e)}",
            "version": "æœªçŸ¥",
            "logged_in": False
        })
```

### 4. è½¬å­˜åŠŸèƒ½ä¿®å¤
**é—®é¢˜**: è½¬å­˜æ—¶æŠ¥é”™ `'BaiduPCSApi' object has no attribute 'save_shared_link'`
**åŸå› **: BaiduPCS-Py APIä¸­æ²¡æœ‰ `save_shared_link` æ–¹æ³•
**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨æ­£ç¡®çš„APIæ–¹æ³•åºåˆ—
1. `access_shared()` - éªŒè¯åˆ†äº«é“¾æ¥å¯†ç 
2. `shared_paths()` - è·å–åˆ†äº«æ–‡ä»¶ä¿¡æ¯
3. `transfer_shared_paths()` - æ‰§è¡Œè½¬å­˜æ“ä½œ

```python
def save_to_pan(self, link, password, save_path):
    try:
        # æ­¥éª¤1: éªŒè¯åˆ†äº«é“¾æ¥å¯†ç 
        self.current_api.access_shared(link, password)
        
        # æ­¥éª¤2: è·å–åˆ†äº«é“¾æ¥çš„æ–‡ä»¶ä¿¡æ¯
        shared_paths = self.current_api.shared_paths(link)
        if not shared_paths:
            return False, "åˆ†äº«é“¾æ¥ä¸­æ²¡æœ‰æ–‡ä»¶"
        
        # æ­¥éª¤3: æ‰§è¡Œè½¬å­˜
        first_path = shared_paths[0]
        fs_ids = [path.fs_id for path in shared_paths]
        
        self.current_api.transfer_shared_paths(
            remotedir=save_path,
            fs_ids=fs_ids,
            uk=first_path.uk,
            share_id=first_path.share_id,
            bdstoken="",  # APIè‡ªåŠ¨å¤„ç†
            shared_url=link
        )
        
        return True, f"æˆåŠŸè½¬å­˜ {len(fs_ids)} ä¸ªæ–‡ä»¶åˆ° {save_path}"
        
    except Exception as e:
        return False, f"è½¬å­˜æš‚ä¸å¯ç”¨ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰: {str(e)[:100]}"
```

## ä¿®å¤ç»“æœ

### âœ… ç•Œé¢ç®€åŒ–æˆåŠŸ
- ç”¨æˆ·åªéœ€è¾“å…¥ä¸€ä¸ªå®Œæ•´Cookieå­—ç¬¦ä¸²
- ç³»ç»Ÿè‡ªåŠ¨æå–BDUSSå’Œå…¶ä»–å¿…è¦ä¿¡æ¯
- ç”¨æˆ·æ“ä½œæ›´åŠ ç®€ä¾¿

### âœ… æœç´¢åŠŸèƒ½æ­£å¸¸
- ä¿®å¤äº†è´¦æˆ·æ£€æŸ¥é€»è¾‘
- æœç´¢åŠŸèƒ½å¯ä»¥æ­£ç¡®è¯†åˆ«å·²é…ç½®çš„è´¦æˆ·
- å®Œæ•´çš„æœç´¢å·¥ä½œæµç¨‹è¿è¡Œæ­£å¸¸

### âœ… ç³»ç»ŸçŠ¶æ€æ˜¾ç¤ºæ­£å¸¸
- BaiduPCS-Py ç‰ˆæœ¬: 0.7.6
- ç™»å½•çŠ¶æ€: æ­£ç¡®æ˜¾ç¤ºç”¨æˆ·é…ç½®çŠ¶æ€
- ç³»ç»Ÿç›‘æ§é¡µé¢ä¿¡æ¯å‡†ç¡®

### âœ… è½¬å­˜åŠŸèƒ½ä¿®å¤
- ä½¿ç”¨æ­£ç¡®çš„BaiduPCS-Py APIæ–¹æ³•
- å®Œæ•´çš„è½¬å­˜æµç¨‹ï¼šéªŒè¯â†’è·å–ä¿¡æ¯â†’è½¬å­˜
- æ™ºèƒ½é”™è¯¯å¤„ç†ï¼šèƒ½è¯†åˆ«ç™¾åº¦æœåŠ¡å™¨çš„"å‡é”™è¯¯"
- é’ˆå¯¹`error_code: 4`ï¼ˆå­˜å‚¨å¥½åƒå‡ºé—®é¢˜äº†ï¼‰è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œå› ä¸ºé€šå¸¸è½¬å­˜å·²æˆåŠŸ

## æµ‹è¯•éªŒè¯

### ç”¨æˆ·æ·»åŠ æµ‹è¯•
```bash
curl 'http://127.0.0.1:5001/api/auth/add-user' \
  -H 'Content-Type: application/json' \
  --data-raw '{"bduss":"å®Œæ•´cookie","cookies":"å®Œæ•´cookie","account_name":"æµ‹è¯•"}'
```
âœ… è¿”å›: `{"message": "ç”¨æˆ· æµ‹è¯• æ·»åŠ æˆåŠŸ", "status": "success"}`

### æœç´¢åŠŸèƒ½æµ‹è¯•
æœç´¢"ç‹‚é£™"æˆåŠŸæ‰¾åˆ°èµ„æºï¼š
- âœ… èµ„æºæœç´¢æ­£å¸¸
- âœ… TMDbç±»å‹åˆ¤æ–­æ­£å¸¸ï¼ˆè¯†åˆ«ä¸ºç”µå½±ï¼‰
- âœ… è½¬å­˜æµç¨‹è°ƒç”¨æ­£å¸¸

### ç³»ç»ŸçŠ¶æ€æµ‹è¯•
```bash
curl 'http://127.0.0.1:5001/api/pan-status'
```
âœ… è¿”å›æ­£å¸¸çŠ¶æ€ä¿¡æ¯

## æŠ€æœ¯æ”¹è¿›æ€»ç»“

1. **ç»Ÿä¸€è®¤è¯ç®¡ç†**: æ‰€æœ‰åŠŸèƒ½éƒ½ä½¿ç”¨ `get_auth_manager()` ç»Ÿä¸€æ¥å£
2. **æ™ºèƒ½Cookieè§£æ**: åç«¯è‡ªåŠ¨å¤„ç†Cookieæ ¼å¼è½¬æ¢
3. **å®Œæ•´APIé€‚é…**: ä½¿ç”¨BaiduPCS-Pyçš„æ­£ç¡®APIæ–¹æ³•
4. **å¢å¼ºé”™è¯¯å¤„ç†**: æ›´å¥½çš„é”™è¯¯ä¿¡æ¯å’Œé™çº§å¤„ç†
5. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**: ç®€åŒ–æ“ä½œæµç¨‹ï¼Œå‡å°‘ç”¨æˆ·å‡ºé”™å¯èƒ½

## ç³»ç»ŸçŠ¶æ€

- ğŸŸ¢ Dockerå®¹å™¨è¿è¡Œæ­£å¸¸
- ğŸŸ¢ æ‰€æœ‰APIæ¥å£å“åº”æ­£å¸¸
- ğŸŸ¢ ç”¨æˆ·è®¤è¯åŠŸèƒ½å®Œæ•´
- ğŸŸ¢ æœç´¢è½¬å­˜å·¥ä½œæµå®Œæ•´
- ğŸŸ¢ ç³»ç»Ÿç›‘æ§æ˜¾ç¤ºæ­£ç¡®
- ğŸŸ¢ ç•Œé¢æ“ä½œç®€åŒ–æˆåŠŸ

## é‡è¦è¯´æ˜ï¼šç™¾åº¦APIçš„"å‡é”™è¯¯"å¤„ç†

### é—®é¢˜ç°è±¡
è½¬å­˜æ—¶å¯èƒ½æ˜¾ç¤ºï¼š`è½¬å­˜å¤±è´¥: error_code: 4, message: å­˜å‚¨å¥½åƒå‡ºé—®é¢˜äº†ï¼Œè¯·ç¨å€™å†è¯•`

### å®é™…æƒ…å†µ
- è¿™æ˜¯ç™¾åº¦æœåŠ¡å™¨çš„å¸¸è§å“åº”
- **è½¬å­˜é€šå¸¸å·²ç»æˆåŠŸå®Œæˆ**
- ç³»ç»Ÿç°åœ¨ä¼šæ™ºèƒ½è¯†åˆ«æ­¤ç±»"å‡é”™è¯¯"

### ä¿®å¤æ–¹æ¡ˆ
```python
except Exception as e:
    error_msg = str(e)
    # æ™ºèƒ½å¤„ç†ç™¾åº¦æœåŠ¡å™¨çš„"å‡é”™è¯¯"
    if "error_code: 4" in error_msg and "å­˜å‚¨å¥½åƒå‡ºé—®é¢˜äº†" in error_msg:
        return True, "è½¬å­˜å®Œæˆï¼ˆç™¾åº¦æœåŠ¡å™¨è¿”å›è­¦å‘Šä¿¡æ¯ï¼Œä½†è½¬å­˜åº”å·²æˆåŠŸï¼Œè¯·æ£€æŸ¥ç½‘ç›˜ï¼‰"
    elif "error_code:" in error_msg:
        return False, f"è½¬å­˜å¯èƒ½å¤±è´¥: {error_msg[:100]}"
    else:
        return False, f"è½¬å­˜å‡ºé”™: {error_msg[:100]}"
```

### ç”¨æˆ·å»ºè®®
å½“é‡åˆ°`error_code: 4`é”™è¯¯æ—¶ï¼š
1. **å…ˆæ£€æŸ¥ç™¾åº¦ç½‘ç›˜** - æ–‡ä»¶é€šå¸¸å·²ç»è½¬å­˜æˆåŠŸ
2. å¦‚æœæ–‡ä»¶ç¡®å®å­˜åœ¨ï¼Œè¯´æ˜è½¬å­˜å·²å®Œæˆ
3. ç³»ç»Ÿç°åœ¨ä¼šè‡ªåŠ¨è¯†åˆ«è¿™ç§æƒ…å†µå¹¶æ˜¾ç¤ºæ­£ç¡®çš„æˆåŠŸä¿¡æ¯

ç³»ç»Ÿç°åœ¨å®Œå…¨å¯ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚