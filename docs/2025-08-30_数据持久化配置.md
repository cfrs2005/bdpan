# 2025-08-30 数据持久化配置实施

## 问题背景

用户报告了一个严重的用户体验问题：容器重启后，用户通过Web界面配置的百度网盘认证信息会丢失，需要重新配置。这是因为之前的配置没有考虑数据持久化。

## 分析发现的需要持久化的文件

### 1. 配置文件
- **config.json**: 应用主配置文件，包含API密钥、转存路径、服务器配置等
- **位置**: `/app/config.json`
- **解决方案**: 文件挂载（可读写，支持Web界面修改）
- **⚠️ 重要**: 应用支持通过Web界面修改配置，需要写权限

### 2. 用户认证数据
- **accounts.json**: 用户百度网盘认证信息
- **位置**: `/root/.baidupcs/accounts.json`
- **解决方案**: Docker数据卷 `bdpan-data`

### 3. 应用日志
- **日志文件**: 应用运行日志
- **位置**: `/app/logs/`
- **解决方案**: Docker数据卷 `bdpan-logs`

## 实施方案

### 1. 更新 docker-compose.yml

**生产环境配置**:
```yaml
volumes:
  # 配置文件 - 可读写挂载，支持Web界面修改配置
  - ./config.json:/app/config.json
  # 用户数据目录 - 存储百度网盘认证信息
  - bdpan-data:/root/.baidupcs
  # 可选：应用日志目录
  - bdpan-logs:/app/logs

volumes:
  # 持久化用户认证数据
  bdpan-data:
    driver: local
  # 持久化应用日志
  bdpan-logs:
    driver: local
```

### 2. 更新 docker-compose.dev.yml

**开发环境配置**:
```yaml
volumes:
  # 配置文件 - 可读写挂载，支持Web界面修改配置
  - ./config.json:/app/config.json
  # 用户数据目录 - 存储百度网盘认证信息
  - bdpan-data-dev:/root/.baidupcs
  # 开发模式代码挂载...

volumes:
  # 开发环境用户认证数据
  bdpan-data-dev:
    driver: local
```

### 3. 更新 README.md

添加了完整的数据持久化说明：

**新增章节**:
- 📦 数据持久化
- 持久化数据类型表格
- 数据备份与恢复命令
- Docker数据卷配置说明

## 用户体验改进

### 之前的问题
- 容器重启后需要重新配置百度网盘Cookie
- 用户认证信息完全丢失
- 没有数据备份机制

### 现在的改进  
- 用户认证信息永久保存在数据卷中
- 容器重启后自动恢复认证状态
- 提供完整的数据备份和恢复方案
- 生产环境和开发环境分离数据卷

## 数据备份命令

**备份认证数据**:
```bash
docker run --rm -v bdpan-data:/data -v $(pwd):/backup alpine tar czf /backup/bdpan-auth-backup.tar.gz -C /data .
```

**恢复认证数据**:
```bash
docker run --rm -v bdpan-data:/data -v $(pwd):/backup alpine tar xzf /backup/bdpan-auth-backup.tar.gz -C /data
```

## Docker Hub 更新

- 重新构建并推送了最新镜像到 `cfrs2005/bdpan-search:latest`
- 镜像本身代码未变化，但用户可以获得最新的docker-compose配置

## 重要修正：config.json 挂载权限

### ❌ 初始错误配置
- 将 `config.json` 设为只读挂载 (`:ro`)
- 导致Web界面无法保存配置修改

### ✅ 修正后配置  
- `config.json` 使用可读写挂载
- 支持用户通过Web界面修改：
  - TMDB API密钥
  - 电影/电视剧转存路径
  - 服务器配置等

### 代码分析证据
```python
# main.py:303 - 应用会保存配置到文件
if save_config(updated_config):
    global config_data
    config_data = updated_config

# main.py:689-699 - save_config函数需要写权限
def save_config(config):
    try:
        with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
        return True
    except Exception as e:
        print(f"保存配置失败: {e}")
        return False
```

## 向后兼容性

- 现有用户升级后，第一次启动会创建新的数据卷
- 需要重新配置一次百度网盘Cookie（之后就会持久化）
- 旧的容器数据不会自动迁移（这是不可避免的）

## 总结

这次更新解决了用户认证信息丢失的问题，同时确保了Web界面配置功能的正常工作。用户现在可以：
1. 通过Web界面修改配置并持久化保存
2. 百度网盘认证信息在容器重启后自动恢复
3. 享受完整的数据备份和恢复支持

数据安全性和用户体验都得到了显著提升。