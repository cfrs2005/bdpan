{% extends "base.html" %}

{% block title %}
历史记录 - 网盘搜索转存系统
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="fas fa-history"></i> 历史记录</h1>
                <p class="text-muted">查看和管理您的搜索和转存历史</p>
            </div>
            <div>
                <button class="btn btn-outline-danger" onclick="clearSearchHistory()">
                    <i class="fas fa-trash-alt"></i> 清除历史
                </button>
                <button class="btn btn-outline-primary" onclick="loadSearchHistory()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-search text-primary fa-2x"></i>
                        <h3 class="mt-2">0</h3>
                        <p class="text-muted mb-0">总搜索次数</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle text-success fa-2x"></i>
                        <h3 class="mt-2">0</h3>
                        <p class="text-muted mb-0">成功转存</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-download text-info fa-2x"></i>
                        <h3 class="mt-2">0</h3>
                        <p class="text-muted mb-0">转存文件数</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-eye text-warning fa-2x"></i>
                        <h3 class="mt-2">0</h3>
                        <p class="text-muted mb-0">今日搜索</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 筛选区域 -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-filter"></i> 数据筛选
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">日期范围</label>
                        <select class="form-select" id="date-filter">
                            <option value="all">全部时间</option>
                            <option value="today">今天</option>
                            <option value="week">本周</option>
                            <option value="month">本月</option>
                            <option value="30">最近30天</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">状态筛选</label>
                        <select class="form-select" id="status-filter">
                            <option value="all">所有状态</option>
                            <option value="success">成功</option>
                            <option value="error">失败</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">关键词搜索</label>
                        <input type="text" class="form-control" id="keyword-filter" placeholder="搜索关键词...">
                    </div>
                </div>
            </div>
        </div>

        <!-- 历史记录表格 -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-list"></i> 详细记录
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="25%">搜索关键词</th>
                                <th width="15%">执行时间</th>
                                <th width="15%">状态</th>
                                <th width="10%">操作</th>
                                <th width="15%">重新搜索</th>
                                <th width="10%">删除记录</th>
                            </tr>
                        </thead>
                        <tbody id="history-list">
                            <!-- 数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <nav aria-label="历史记录分页">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 分页将通过JavaScript动态生成 -->
                    </ul>
                </nav>
            </div>
        </div>

        <!-- 为空状态 -->
        <div id="empty-state" style="display: none;">
            <div class="text-center py-5">
                <i class="fas fa-history fa-5x text-muted mb-3"></i>
                <h4>暂无历史记录</h4>
                <p class="text-muted">
                    开始搜索您的第一个影视资源，这里将显示所有的搜索历史记录。
                </p>
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-search"></i> 开始搜索
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 历史详情模态框 -->
<div class="modal fade" id="history-detail-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">任务详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-borderless">
                    <tr>
                        <td width="20%" class="text-muted">搜索关键词:</td>
                        <td><strong id="history-keyword"></strong></td>
                    </tr>
                    <tr>
                        <td class="text-muted">执行时间:</td>
                        <td id="history-time"></td>
                    </tr>
                    <tr>
                        <td class="text-muted">执行状态:</td>
                        <td><span id="history-status"></span></td>
                    </tr>
                </table>
                
                <div class="mt-3">
                    <h6>执行日志:</h6>
                    <div id="history-logs"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="" id="re-search-btn">
                    <i class="fas fa-redo"></i> 重新搜索
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 历史记录页面专用脚本
$(document).ready(function() {
    // 更新统计信息
    updateStatistics();
    
    // 绑定筛选事件
    $('#date-filter, #status-filter, #keyword-filter').on('change keyup', applyFilters);
    
    // 加载历史记录
    loadSearchHistory();
});

// 更新统计信息
function updateStatistics() {
    const history = getSearchHistory();
    const now = Date.now();
    const today = now - (24 * 60 * 60 * 1000);
    
    // 总搜索次数
    const totalSearches = history.length;
    
    // 成功转存数量
    const successSearches = history.filter(item => item.status === 'success').length;
    
    // 估算转存文件数（假设每次成功转存平均5个文件）
    const estimatedFiles = successSearches * 5;
    
    // 今日搜索次数
    const todaySearches = history.filter(item => item.timestamp >= today).length;
    
    // 更新统计显示
    $('.card h3').eq(0).text(totalSearches);
    $('.card h3').eq(1).text(successSearches);
    $('.card h3').eq(2).text(estimatedFiles);
    $('.card h3').eq(3).text(todaySearches);
}

// 应用筛选器
function applyFilters() {
    const dateFilter = $('#date-filter').val();
    const statusFilter = $('#status-filter').val();
    const keywordFilter = $('#keyword-filter').val().toLowerCase();
    
    const history = getSearchHistory();
    const now = Date.now();
    
    let filtered = history.filter(item => {
        // 日期筛选
        let datePassed = true;
        if (dateFilter !== 'all') {
            const cutoff = new Date();
            switch(dateFilter) {
                case 'today':
                    cutoff.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    cutoff.setDate(cutoff.getDate() - 7);
                    break;
                case 'month':
                    cutoff.setMonth(cutoff.getMonth() - 1);
                    break;
                case '30':
                    cutoff.setDate(cutoff.getDate() - 30);
                    break;
            }
            datePassed = item.timestamp >= cutoff.getTime();
        }
        
        // 状态筛选
        let statusPassed = statusFilter === 'all' || item.status === statusFilter;
        
        // 关键词筛选
        let keywordPassed = keywordFilter === '' || item.keyword.toLowerCase().includes(keywordFilter);
        
        return datePassed && statusPassed && keywordPassed;
    });
    
    // 重新加载过滤后的数据
    renderFilteredData(filtered);
}

// 渲染筛选数据
function renderFilteredData(filteredData) {
    const container = $('#history-list');
    
    if (filteredData.length === 0) {
        container.html(`
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-search fa-2x"></i>
                    <p class="mt-2">没有找到匹配的记录</p>
                </td>
            </tr>
        `);
        return;
    }
    
    let html = '';
    filteredData.forEach(item => {
        const statusClass = item.status === 'success' ? 'text-success' : 'text-danger';
        const statusIcon = item.status === 'success' ? 'fa-check-circle' : 'fa-times-circle';
        
        html += `
            <tr>
                <td>
                    <strong>${item.keyword}</strong>
                    <br>
                    <small class="text-muted">${formatDateTime(item.timestamp)}</small>
                </td>
                <td>${formatDateTime(item.timestamp)}</td>
                <td>
                    <span class="${statusClass}">
                        <i class="fas ${statusIcon}"></i>
                        ${item.status}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-info" onclick='showHistoryDetails(${JSON.stringify(item).replace(/"/g, '&quot;')})'>
                        <i class="fas fa-eye"></i> 详情
                    </button>
                </td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick='searchAgain("${item.keyword}")'>
                        <i class="fas fa-redo"></i> 搜索
                    </button>
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick='deleteHistory(${JSON.stringify(item).replace(/"/g, '&quot;')})'>
                        <i class="fas fa-trash"></i> 删除
                    </button>
                </td>
            </tr>
        `;
    });
    
    container.html(html);
}

// 删除单条历史记录
function deleteHistory(item) {
    if (confirm(`确定要删除 "${item.keyword}" 这条记录吗？`)) {
        const history = getSearchHistory();
        const newHistory = history.filter(h => 
            !(h.keyword === item.keyword && h.timestamp === item.timestamp)
        );
        
        localStorage.setItem('searchHistory', JSON.stringify(newHistory));
        loadSearchHistory();
        applyFilters();
        updateStatistics();
        showAlert('删除成功！', 'success');
    }
}

// 导出历史记录
function exportHistory() {
    const history = getSearchHistory();
    const dataStr = JSON.stringify(history, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `search-history-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}
</script>
{% endblock %}